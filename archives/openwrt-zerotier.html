<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>OpenWrt ZeroTier 跨地区组网 · ILOFT · 我的阁楼</title><meta name="description" content="OpenWrt ZeroTier 跨地区组网 - Yu"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.iloft.xyz/atom.xml" title="ILOFT · 我的阁楼"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ILOFT · 我的阁楼" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">LOFT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about/" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/links/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">OpenWrt ZeroTier 跨地区组网</h1><div class="post-info">2020年11月23日</div><div class="post-content"><p>　　之前一直在用 Ocserv 或者 Softether 进行组网，但是这两者不能比较好的去中心化，且需要公网 IP，总的来说不适合跨地区的家庭组网。这次考虑使用 ZeroTier 进行组网，参考了相关的教程，发现很多都选择采用 iptables 对网络进行 NAT 的方式，不仅配置繁琐，还会损失性能。这里直接使用静态路由的方式，无需多余配置，性能也比较好。</p><span id="more"></span><p>　　以一个三节点的网络为例：两台路由器 Openwrt 版本分别为 18.06 与 19.04，一台服务器部署了 Ocserv 用于不能直接使用 ZeroTier 设备通过 VPN 接入，网段如下。</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZeroTier：<span class="number">10.244.0.0</span>/<span class="number">24</span></span><br><span class="line">路由器 <span class="keyword">A</span>（Openwrt）：<span class="number">172.16.0.1</span>/<span class="number">16</span></span><br><span class="line">路由器 B（Openwrt）：<span class="number">172.17.0.1</span>/<span class="number">16</span></span><br><span class="line">服务器 C（Ocserv）：<span class="number">192.168.30.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure><p>　　关于 ZeroTier 注册和 Ocserv 相关的设置就不赘述了，主要关注 Openwrt 的相关的配置。</p><h2 id="安装-ZeroTier"><a href="#安装-ZeroTier" class="headerlink" title="安装 ZeroTier"></a>安装 ZeroTier</h2><p>　　安装 ZeroTier 非常简单，使用 ssh 登录路由器，使用包管理器安装即可，使用 LUCI 图形化安装也行，不过下面的配置仍需要在命令行中进行。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ opkg update</span><br><span class="line">$ opkg install zerotier</span><br></pre></td></tr></table></figure><h2 id="配置-ZeroTier"><a href="#配置-ZeroTier" class="headerlink" title="配置 ZeroTier"></a>配置 ZeroTier</h2><p>　　安装完成后，编辑配置文件 <code>vi /etc/config/zerotier</code>，初始配置文件如下：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">config zerotier sample_config</span><br><span class="line">        <span class="keyword">option</span> enabled <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        # persistent <span class="keyword">configuration</span> folder (<span class="keyword">for</span> ZT controller mode)</span><br><span class="line">        #<span class="keyword">option</span> config_path <span class="string">&#x27;/etc/zerotier&#x27;</span></span><br><span class="line"></span><br><span class="line">        #<span class="keyword">option</span> port <span class="string">&#x27;9993&#x27;</span></span><br><span class="line"></span><br><span class="line">        # Generate secret <span class="keyword">on</span> first <span class="keyword">start</span></span><br><span class="line">        <span class="keyword">option</span> secret <span class="string">&#x27;generate&#x27;</span></span><br><span class="line"></span><br><span class="line">        # <span class="keyword">Join</span> a <span class="built_in">public</span> network <span class="keyword">called</span> Earth</span><br><span class="line">        list <span class="keyword">join</span> <span class="string">&#x27;8056c2e21c000001&#x27;</span></span><br></pre></td></tr></table></figure><p>　　需要修改的地方只有两处：</p><ol><li><code>option enabled 0</code> 将 <code>0</code> 修改为 <code>1</code>。</li><li><code>list join &#39;8056c2e21c000001&#39;</code> 将 Earth 网络 id 修改自己的私有网络 id。</li></ol><p>　　完成后执行命令启动即可。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/zerotier start</span><br></pre></td></tr></table></figure><p>　　可以通过命令查看连接到的网络，建议不用着急去 ZeroTier 网页配置 IP，等全部配置完成后再进行统一规划，避免敲错网段导致断网（逃。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zerotier-cli listnetworks</span><br></pre></td></tr></table></figure><h2 id="创建接口与防火墙"><a href="#创建接口与防火墙" class="headerlink" title="创建接口与防火墙"></a>创建接口与防火墙</h2><p>　　为了便于配置，我们需要为 ZeroTier 创建的网卡创建一个接口和独立的防火墙，如图所示：<br>　　创建一个叫 ZeroTier 的接口，绑定 ZeroTier 创建的虚拟网卡。<br><img src="/images/zerotier-create-interface.png" alt="创建接口"><br>　　保存后，为 ZeroTier 创建一个专属的防火墙区域，也叫 ZeroTier。<br><img src="/images/zerotier-create-firewall.png" alt="创建防火墙"></p><h2 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a>配置防火墙</h2><p>　　创建完成后，配置 ZeroTier 的防火墙，如图所示：</p><ol><li>Input、Output、Forward 全部允许。</li><li>允许 ZeroTier 转发至 lan。</li><li>允许 ZeroTier 转发自 lan。<br><img src="/images/zerotier-firewall.png" alt="配置防火墙"></li></ol><h2 id="Zerotier-网页配置"><a href="#Zerotier-网页配置" class="headerlink" title="Zerotier 网页配置"></a>Zerotier 网页配置</h2><p>　　接着登录 ZeroTier 网站，为我们的设备分配 IP。</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZeroTier：<span class="number">10.244.0.0</span>/<span class="number">24</span></span><br><span class="line">路由器 <span class="keyword">A</span>（Openwrt）：<span class="number">172.16.0.1</span>/<span class="number">16</span>      <span class="number">10.244.16.1</span></span><br><span class="line">路由器 B（Openwrt）：<span class="number">172.17.0.1</span>/<span class="number">16</span>      <span class="number">10.244.17.1</span></span><br><span class="line">服务器 C（Ocserv）：<span class="number">192.168.30.0</span>/<span class="number">24</span>     <span class="number">10.244.30.1</span></span><br></pre></td></tr></table></figure><p>　　接着在网页添加静态路由，如图所示：<br><img src="/images/zerotier-route.png" alt="静态路由"></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>　　完成上面的配置后，网络就打通了，无需使用 iptables 进行 NAT。<br>　　在路由器 B 上执行 <code>ip route</code> 可以看到 ZeroTier 下发的路由表。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ip route</span><br><span class="line">10.244.0.0/16 dev ztyouvscim proto kernel scope <span class="built_in">link</span> src 10.244.17.1</span><br><span class="line">172.16.0.0/16 via 10.244.16.1 dev ztyouvscim</span><br><span class="line">172.17.0.0/16 dev br-lan proto kernel scope <span class="built_in">link</span> src 172.17.0.1</span><br><span class="line">192.168.30.0/24 via 10.244.30.1 dev ztyouvscim</span><br></pre></td></tr></table></figure><p>　　在路由器 A 上也可以 traceroute B 路由器下的设备，说明我们完成了组网的工作。<br><img src="/images/zerotier-traceroute.png" alt="路由追踪"></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>　　如果对配置看得不是很懂，可以参考下面这篇文章，配图更加详细，防火墙的配置按照本文来即可。</p><ol><li><a target="_blank" rel="noopener" href="https://engrzhou.github.io/2018/07/Openwrt%E8%B7%AF%E7%94%B1%E9%80%9A%E8%BF%87Zerotier%E7%BB%84%E7%BD%91%E5%AE%9E%E7%8E%B0%E5%BC%82%E5%9C%B0%E5%86%85%E7%BD%91%E4%BA%92%E8%AE%BF/">Openwrt路由通过Zerotier组网实现异地内网互访</a></li></ol></div></article></div></main><footer><div class="paginator"><a class="prev" href="/archives/bye2021.html">上一篇</a><a class="next" href="/archives/lets-encrypt-boulder-reference.html">下一篇</a></div><div id="giscus"></div><script src="https://giscus.app/client.js" data-repo="myloft/blog" data-repo-id="MDEwOlJlcG9zaXRvcnk5MTQ0MTQ5Nw==" data-category="Announcements" data-category-id="DIC_kwDOBXNJWc4CT54-" data-mapping="  mapping: pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>></script><div class="copyright"><p>© 2013 - 2025 <a href="https://www.iloft.xyz">Yu</a>, Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="/sitemap.xml" target="_blank">Sitemap</a></p><p><a href="https://beian.miit.gov.cn/" target="_blank">苏ICP备16033901号-3</a></p></div></footer></div><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-89639365-1","auto"),ga("send","pageview")</script></body></html>