<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>我的家庭 NAS 方案（当前进化至 EPYC 7D12 + TrueNAS） · ILOFT · 我的阁楼</title><meta name="description" content="我的家庭 NAS 方案（当前进化至 EPYC 7D12 + TrueNAS） - Yu"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.iloft.xyz/atom.xml" title="ILOFT · 我的阁楼"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ILOFT · 我的阁楼" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">LOFT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about/" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/links/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">我的家庭 NAS 方案（当前进化至 EPYC 7D12 + TrueNAS）</h1><div class="post-info">2025年6月24日</div><div class="post-content"><blockquote><p><strong>PS：2025 年 10 月 30 日，问题已定位，BMC 会在主板的所有网口周期发送数据包（探测包？），如果 2.5Gbps 网口（非管理口）未接线，会导致其内核持续内存泄露，直至 OOM。解决办法是在 BMC 里禁用该网口。</strong></p></blockquote><blockquote><p><strong>PS：截止 2025 年 10 月 8 日，H12D BMC 模块存在内存泄露的 BUG，导致每 14～15 天就会挂死（IPMI 相关进程都被杀死了），管理界面、IPMI、风扇控制全部失灵，只能拔电源冷重启，暂不建议购买。</strong></p></blockquote><p>用了很久 NAS 了，简单记录一下 NAS 方案演进。</p><span id="more"></span><h2 id="初探-NAS（小而美）"><a href="#初探-NAS（小而美）" class="headerlink" title="初探 NAS（小而美）"></a>初探 NAS（小而美）</h2><p>&emsp;&emsp;刚玩 NAS 的时候，对 NAS 的理解就是稳定 7 x 24 开机的网络存储平台。硬件方面采用 DQ77KB + i5 3570S + 蜗牛星际方案（<a href="https://www.iloft.xyz/archives/dq77kb-nas.html">DQ77KB + 矿渣机箱翻车记</a>）。软件平台直接使用 Windows Server 开启 SMB，同时用 QBittorrent RSS 自动下载，配合 Jellyfin 进行刮削。</p><p><img src="/images/NAS-Case.jpg" alt="NAS机箱"></p><p>&emsp;&emsp;整体使用起来还是很舒服的，可以称作小而美。DQ77KB 自带 AMT（IPMI）， 配置完成后可以扔在角落吃灰，也奠定了后续演进一定要有带外管理便于远程摸鱼救砖的方针。</p><h2 id="转向服务器平台（换汤不换药）"><a href="#转向服务器平台（换汤不换药）" class="headerlink" title="转向服务器平台（换汤不换药）"></a>转向服务器平台（换汤不换药）</h2><p>&emsp;&emsp;随着库存数据越来越多，i5 3570S 性能瓶颈逐渐出现，最主要的是编解码性能，使用 Jellyfin 观看高清视频时拖拽会卡顿。同时因为矿盘逐渐增加，盘位不够，因此换成了 R730XD 12 盘位（E5 2680v4 x 2）。</p><p><img src="/images/r730xd.jpg" alt="r730xd"></p><p>&emsp;&emsp;服务器配齐了前后 12 + 2 盘，H730 阵列卡，服务器内部看起来非常舒心。</p><p><img src="/images/r730xd_1.jpg" alt="r730xd内部"></p><p>&emsp;&emsp;为什么说是换汤不换药呢，是因为这个阶段软件并没有发生变化，只是单纯的将系统迁移到新平台，解决了 Jellyfin 观看视频卡顿痛点。尴尬的是后面买了 AppleTV 使用 infuse 播放直接把转码问题给消灭了。总得来说，最初我对 R730XD 还是很满意的。其他用户反馈的噪音大的问题，在 4~6 盘情况下，通过更换静音风扇与配合 IPMI 调速到 20%，温度和噪音都是可接受的，隔一扇门基本无感。</p><h2 id="失败的硬阵列尝试（适合自己的才是最好的）"><a href="#失败的硬阵列尝试（适合自己的才是最好的）" class="headerlink" title="失败的硬阵列尝试（适合自己的才是最好的）"></a>失败的硬阵列尝试（适合自己的才是最好的）</h2><p>&emsp;&emsp;就这样度过了美好的 3 年，在 R730XD 逐步加盘的过程，问题出现了，每次迁移数据比较麻烦，需要硬盘一次次的拷贝，并且需要对盘符和路径做复杂处理才能让各种软件不感知变化。我决定一次性购入 8 块 16T MG08 通过 H730 组建硬阵列，毕其功于一役。</p><p><img src="/images/8mg08.jpg" alt="MG08"></p><p>&emsp;&emsp;此时的我还是很信任企业级的方案，选择硬阵列也是考虑到硬阵列可以屏蔽底层细节，向上层 Windows 直接虚拟出硬盘，不需要操作系统和软件层面做任何改动，80T 左右的可用空间也足够我较长时间使用。而如果使用在软阵列里性能相对较好比较靠谱的 TrueNAS 方案，就需要将物理机上的 Windows 虚拟化，作为一个懒人自然不予考虑。</p><p>&emsp;&emsp;理想是美好的，现实是骨感的。当插上所有硬盘，开启阵列的创建之后，痛苦开始了。由于硬阵列是基于块和条带的，因此创建阵列完毕一定需要初始化（填 0 和计算奇偶校验）。此时硬盘会持续写入，简单计算可知 16T &#x2F; 200MB&#x2F;s &#x3D; 22 小时。由于机架服务器的设计，进风几乎都来自前置硬盘位，因此插满硬盘后，会严重影响进风。这高速写入的 22 小时，风扇需要 50%+ 才能压制住机器，即使如此硬盘也保持在了 50℃+，吸尾气的 CPU 分分钟突破 90℃，此时噪音和热量根本无法忍受！！！</p><p>&emsp;&emsp;在组阵列，睡前关机，睡醒开机继续组阵列后，以及多次修改参数，尝试提升速度重新开始后，我终于崩溃了。将服务器挂到闲鱼上以 1200 的价格卖了出去（购入价 2000）。这里用我的血泪告诫大家，没有机柜和独立的设备间还是不要玩机架服务器了~当然我相信，机架服务器永远是 NAS 的最终的归宿，希望有一天能够把公司的星星海搬回家。</p><h2 id="取其精华去其糟粕"><a href="#取其精华去其糟粕" class="headerlink" title="取其精华去其糟粕"></a>取其精华去其糟粕</h2><p>&emsp;&emsp;痛定思痛之后，明白了我的需求从来没有变过，那就是“在角落吃灰”，它在这个物理世界需要足够安静和稳定。基于这个目的，就开始了硬件平台的选择。正巧最近 EPYC 7D12 大船到岸只需要 240，32 核 64 线程（1.10GHz ~ 3.00GHz），TDP 80W 简直就是 NAS 佬的梦中情 U。ZEN2 架构性能毋庸置疑，同时功耗发热足够低，无需像使用 E5 双路时修改功耗策略。</p><p>&emsp;&emsp;确定了 CPU 就要配套主板了，板 U 守恒定律名不虚传，二手的超微 H12SSL 以及华硕技嘉的主板价格都突破了 3000， 相较年初翻了一翻，说实话不是很好的选择了，因此就选择了寨板大厂华南金牌 H12D-8D，带有 BMC 模组可以满足基本的使用，同时有 3 个 8643 接口以及 4 个 SATA，满足了 16 盘的需求，不需要额外购买阵列卡。</p><p>&emsp;&emsp;剩下的最重要的就是选择机箱了，在乔思伯 N5 和梵隆 12 盘位中纠结了一段时间，考虑到无论是全高还是半高的梵隆散热器都限高，暴力风扇的阴影还笼罩在心头，因此还是选择了可以安装 12cm&#x2F;14cm 风扇的乔思伯。需要注意的是两点，一是乔思伯的背板是 SATA 的，需要购买 8643 转 SATA。二是乔思伯自带的三把风扇是 3Pin 非 PWM 调速，因此噪音会比较大，建议换 PWM 调速风扇。</p><p>&emsp;&emsp;购买&#x2F;装机清单如下：</p><ul><li>CPU：EPYC 7D12 ¥258.00</li><li>主板：华南金牌 H12D-8D BMC ¥2307.99</li><li>内存：三星 DDR4 64Gx4 ¥1467.15</li><li>散热器：利民 TA120EX TR4 SP3 ¥208.57</li><li>机箱风扇：利民 TL-G12Bx3 ¥68.36</li><li>电源：长城 N8 850W 金牌 ¥565.03</li><li>机箱：乔思伯 N5 ¥1140.40</li><li>固态 1（SLOG）：Intel 傲腾 900P 280G ¥534.00</li><li>固态 2（PVE）：Samsung PM981a 512GB ¥0.00 (存货)</li><li>固态 3 (缓存)：Intel S3520 800GB ¥0.00 (存货)</li><li><strong>总计：¥6549.50</strong></li></ul><p>&emsp;&emsp;安装过程是枯燥的，也没有太多值得说到的，箱子做工对于这个价位中规中矩，建议从下往上安装，把硬盘背板先装好，我的这个长城 N8 电源的 SATA 供电在接完背板之后就无法送到上层安装 2.5 寸 SSD 了，因此 S3520 扔在了下层。同时由于 7D12 内存缺通道（4 通道）所以需要多尝试尝试，最终我的这块 U 需要将内存安装在最外侧的插槽才能识别全部 256GB 内存。</p><p><img src="/images/board.jpg" alt="board"></p><p>&emsp;&emsp;这里可以发现，由于主板 CPU 插槽设计的朝向，CPU 风扇（侧吹）和机箱风扇（后吹）风向不是一致的，可能会影响风道，如果用服务器 2U 暴力风扇应该是一致的。个人因为比较懒，且 7D12 功耗不高，就不愿意再将机箱风扇调整到右侧了。同时需要提醒的是华南 H12D 的主板风扇只有两个风扇接口支持温控调速（我图上 CPU 和上层风扇所接的右上角接口）。用起来会发觉风扇很吵，调了很久主板 PWM 调速不见效果，仔细研究后才发现下层的风扇接的主板接口是 ipmi 手动调速的，并不支持温控（服务器好的不学，净学些坏的）。不过手动调整转速到 1000 RPM后，即使机箱放在床边也几乎无感了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调速到 66%（0x42%），利民风扇全速 1500RPM</span></span><br><span class="line">ipmitool -I lanplus -H 172.17.0.199 -U admin -P admin raw 0x0e 0x65 0 0x42</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这是安装完成的效果，机箱很大可能图片上看不出来，橡胶把手凑合能用，真想拔出硬盘的时候会很担心拔断，比硬盘托架肯定差远了，不过确实是 12 盘位里比较好看的了：</p><p><img src="/images/n5-case1.jpg" alt="n5-case1"></p><p><img src="/images/n5-case2.jpg" alt="n5-case2"></p><p>&emsp;&emsp;忙完了硬件就是忙软件层面了，因为放弃了灵活性较差的硬阵列，所以这一代软件方案底层采用 PVE 虚拟化平台， 将之前物理硬盘安装的 Windows Server 进行虚拟化，同时运行 TrueNAS。并将全部 SATA 控制器以及 PCIE 的傲腾 900P 直通给 TrueNAS。</p><p><img src="/images/pve.png" alt="pve"></p><p>&emsp;&emsp;然后就是繁琐的软阵列创建和数据迁移工作，这里需要注意 TrueNAS 在 Scale 版本移除了 WEB 界面的数据导入以及内核里的 NTFS 支持，因此我是在 Core 版本将原始的 NTFS 硬盘数据完成迁移后再升级到 Scale 的。</p><p>&emsp;&emsp;总结一下，当前存储方案是，8 块 MG08 组成 RADIZ2，傲腾 900P 分出 32GB 分区作为阵列的 SLOG。RAIDZ2 使用 SMB 共享给 Window Server，实测 Jellyfin（不能运行在服务模式）和 QBittorrent 等软件都能正常运行。同时 S3520 创建 ZVOL 分区 iSCSI 挂载给 Windows Server 做下载缓存盘，减少阵列读写（夜间持续咯哒咯哒还是有点小烦）。</p><p><img src="/images/truenas.png" alt="truenas"></p><p><img src="/images/windows.png" alt="windows"></p><p>&emsp;&emsp;至此我的第三代 NAS 也完成了软硬件升级（PS：买的 Mellanox CX4 25Gbps 网卡还在路上，不过应该对 NAS 整体架构没有太大影响）~</p><h2 id="小更新"><a href="#小更新" class="headerlink" title="小更新"></a>小更新</h2><p>&emsp;&emsp;CX4 网卡到手了，SR-IOV 直通 TrueNAS 和 Windows 相较 VirtIO 性能在网络传输性能上确实有大幅度提升，贴一下 Windows 远程读写 TrueNAS SMB 性能吧，性能够用。<br><img src="/images/cdm-nas-smb.png" alt="truenas"></p></div></article></div></main><footer><div class="paginator"><a class="next" href="/archives/my-network-vlan.html">下一篇</a></div><div id="giscus"></div><script src="https://giscus.app/client.js" data-repo="myloft/blog" data-repo-id="MDEwOlJlcG9zaXRvcnk5MTQ0MTQ5Nw==" data-category="Announcements" data-category-id="DIC_kwDOBXNJWc4CT54-" data-mapping="  mapping: pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>></script><div class="copyright"><p>© 2013 - 2025 <a href="https://www.iloft.xyz">Yu</a>, Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="/sitemap.xml" target="_blank">Sitemap</a></p><p><a href="https://beian.miit.gov.cn/" target="_blank">苏ICP备16033901号-3</a></p></div></footer></div><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-89639365-1","auto"),ga("send","pageview")</script></body></html>