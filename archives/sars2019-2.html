<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>SARS 2019 第二周打卡（验证码生成） · ILOFT · 我的阁楼</title><meta name="description" content="SARS 2019 第二周打卡（验证码生成） - Yu"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.iloft.xyz/atom.xml" title="ILOFT · 我的阁楼"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ILOFT · 我的阁楼" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">LOFT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about/" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/links/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">SARS 2019 第二周打卡（验证码生成）</h1><div class="post-info">2019年8月25日</div><div class="post-content"><p>　　SARS 学习计划的第二周即将结束了。参加的数字识别和新生入学小助手小组的开发都在平稳的推进中，由于在两组中分别选择了微信小程序和前端开发。因此我主要还是以学习前端和小程序开发为主，暂时还没有具体的开发任务，只是进行了一些打杂工作。数字识别小组的任务是识别软微综合信息服务平台的验证码。没有真实的验证码作为训练数据，就不能完成这个任务。由于组里的各位大佬都忙于算实现，因此就由前端组我来生成这些验证码。<span id="more"></span></p><p>　　首先通过观察服务器的响应头中的 X-Powered-By 字段可以发现服务端采用的是 ThinkPHP。随意构造一个链接发现未关闭 Debug 模式，使用的 ThinkPHP 版本为 3.2.2。<br><img src="/images/thinkphp-debug.png" alt="ThinkPHP3.2.2"><center>图 1 原始图像</center><br>　　知道了框架的版本问题就很简单了，去 ThinkPHP 官网下载框架并在电脑上部署。<br><img src="/images/thinkphp.png" alt="ThinkPHP"><center>图 2 部署 ThinkPHP</center><br>　　通过阅读 PHP 语法和 ThinkPHP 的文档，尝试修改 IndexController.class.php 调用 ThinkPHP 提供的 Think\Verify 类。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Verify</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$verify</span> = <span class="keyword">new</span> <span class="title class_">Verify</span>(<span class="variable">$config</span>);</span><br><span class="line">        <span class="variable">$verify</span>-&gt;<span class="title function_ invoke__">entry</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　访问首页，成功显示验证码图像。<br><img src="/images/captcha-1.png" alt="生成验证码图像"><center>图 3 生成验证码图像</center><br>　　修改验证码参数使得验证码风格与综合服务平台验证码一致。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;useImgBg&#x27;</span> =&gt; <span class="literal">false</span>,           <span class="comment">// 使用背景图片</span></span><br><span class="line">            <span class="string">&#x27;fontSize&#x27;</span> =&gt; <span class="number">16</span>,              <span class="comment">// 验证码字体大小(px)</span></span><br><span class="line">            <span class="string">&#x27;useCurve&#x27;</span> =&gt; <span class="literal">true</span>,            <span class="comment">// 是否画混淆曲线</span></span><br><span class="line">            <span class="string">&#x27;useNoise&#x27;</span> =&gt; <span class="literal">false</span>,           <span class="comment">// 是否添加杂点</span></span><br><span class="line">            <span class="string">&#x27;imageH&#x27;</span>   =&gt; <span class="number">37</span>,              <span class="comment">// 验证码图片高度</span></span><br><span class="line">            <span class="string">&#x27;imageW&#x27;</span>   =&gt; <span class="number">120</span>,             <span class="comment">// 验证码图片宽度</span></span><br><span class="line">            <span class="string">&#x27;length&#x27;</span>   =&gt; <span class="number">4</span>,               <span class="comment">// 验证码位数</span></span><br><span class="line">            <span class="string">&#x27;codeSet&#x27;</span>  =&gt; <span class="string">&#x27;0123456789&#x27;</span>,    <span class="comment">// 验证码字符集合</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$num</span> = <span class="number">0</span>; <span class="variable">$num</span> &lt; <span class="number">10</span>; <span class="variable">$num</span>++) &#123;</span><br><span class="line">            <span class="variable">$verify</span> = <span class="keyword">new</span> <span class="title class_">Verify</span>(<span class="variable">$config</span>);</span><br><span class="line">            <span class="variable">$verify</span>-&gt;<span class="title function_ invoke__">entry</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/captcha-2.png" alt="修改参数后的验证码图像"><center>图 4 修改参数后的验证码图像</center><br>　　尽管实现了验证码生成，但此时并不知道生成的验证码的明文，而且验证码是展示在网页上的。为了实现一个能够批量生成验证码到本地的工具，尝试对 Think\Verify 进行修改。通过阅读代码，首先找到输出验证码的代码块。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存验证码</span></span><br><span class="line"><span class="variable">$key</span>                   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">authcode</span>(<span class="variable">$this</span>-&gt;seKey);</span><br><span class="line"><span class="variable">$code</span>                  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">authcode</span>(<span class="title function_ invoke__">strtoupper</span>(<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$code</span>)));</span><br><span class="line"><span class="variable">$secode</span>                = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$secode</span>[<span class="string">&#x27;verify_code&#x27;</span>] = <span class="variable">$code</span>; <span class="comment">// 把校验码保存到session</span></span><br><span class="line"><span class="variable">$secode</span>[<span class="string">&#x27;verify_time&#x27;</span>] = NOW_TIME; <span class="comment">// 验证码创建时间</span></span><br><span class="line"><span class="title function_ invoke__">session</span>(<span class="variable">$key</span> . <span class="variable">$id</span>, <span class="variable">$secode</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Cache-Control: private, max-age=0, no-store, no-cache, must-revalidate&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Cache-Control: post-check=0, pre-check=0&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Pragma: no-cache&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;content-type: image/png&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出图像</span></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$this</span>-&gt;_image);</span><br><span class="line"><span class="title function_ invoke__">imagedestroy</span>(<span class="variable">$this</span>-&gt;_image);</span><br></pre></td></tr></table></figure><p>　　阅读 PHP 文档了解 imagepng() 的使用方法，修改代码实现保存。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存验证码</span></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$this</span>-&gt;_image, <span class="variable">$code</span>.<span class="string">&#x27;.png&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">imagedestroy</span>(<span class="variable">$this</span>-&gt;_image);</span><br></pre></td></tr></table></figure><p>　　访问网页根目录下出现了一张验证码图像。<br><img src="/images/captcha-3.png" alt="验证码保存到本地"><center>图 5 验证码保存到本地</center><br>　　尽管出现了一张验证码图像，但是文件名却不是我们想要的，继续阅读代码发现ThinkPHP为了安全会将生成好的验证码字符串加密后存储到session中，用户传来的验证码字符串也需要先进行加密，再与session中的字符串进行对比来判断是否输入正确。但是这些步骤以及服务器响应头对于生成训练数据来说并没有什么用，全部删除仅保留两行，并将每个字符拼接成字符串。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$this</span>-&gt;_image, <span class="variable">$code</span>[<span class="number">0</span>].<span class="variable">$code</span>[<span class="number">1</span>].<span class="variable">$code</span>[<span class="number">2</span>].<span class="variable">$code</span>[<span class="number">3</span>].<span class="string">&#x27;.png&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">imagedestroy</span>(<span class="variable">$this</span>-&gt;_image);</span><br></pre></td></tr></table></figure><p>　　访问网页，此时出现了一张正确命名的验证码图像。<br><img src="/images/captcha-4.png" alt="验证码保存到本地"><center>图 6 正确命名的验证码</center><br>　　完成了这些工作后只需要增加一个循环就可以批量生成验证码图像了。尝试生成 10 个验证码图像。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;useImgBg&#x27;</span> =&gt; <span class="literal">false</span>,           <span class="comment">// 使用背景图片</span></span><br><span class="line">        <span class="string">&#x27;fontSize&#x27;</span> =&gt; <span class="number">16</span>,              <span class="comment">// 验证码字体大小(px)</span></span><br><span class="line">        <span class="string">&#x27;useCurve&#x27;</span> =&gt; <span class="literal">true</span>,            <span class="comment">// 是否画混淆曲线</span></span><br><span class="line">        <span class="string">&#x27;useNoise&#x27;</span> =&gt; <span class="literal">false</span>,           <span class="comment">// 是否添加杂点</span></span><br><span class="line">        <span class="string">&#x27;imageH&#x27;</span>   =&gt; <span class="number">37</span>,              <span class="comment">// 验证码图片高度</span></span><br><span class="line">        <span class="string">&#x27;imageW&#x27;</span>   =&gt; <span class="number">120</span>,             <span class="comment">// 验证码图片宽度</span></span><br><span class="line">        <span class="string">&#x27;length&#x27;</span>   =&gt; <span class="number">4</span>,               <span class="comment">// 验证码位数</span></span><br><span class="line">        <span class="string">&#x27;codeSet&#x27;</span>  =&gt; <span class="string">&#x27;0123456789&#x27;</span>,    <span class="comment">// 验证码字符集合</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$num</span> = <span class="number">0</span>; <span class="variable">$num</span> &lt; <span class="number">10</span>; <span class="variable">$num</span>++) &#123;</span><br><span class="line">        <span class="variable">$verify</span> = <span class="keyword">new</span> <span class="title class_">Verify</span>(<span class="variable">$config</span>);</span><br><span class="line">        <span class="variable">$verify</span>-&gt;<span class="title function_ invoke__">entry</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/captcha-5.png" alt="验证码保存到本地"><center>图 7 生成的 10 张验证码图像</center><br>　　尽管面对的是一门不了解的语言和框架，由于有充足的文档，因此生成工作还是比较简单的。</p></div></article></div></main><footer><div class="paginator"><a class="prev" href="/archives/sars2019-4.html">上一篇</a><a class="next" href="/archives/sars2019-1.html">下一篇</a></div><div id="giscus"></div><script src="https://giscus.app/client.js" data-repo="myloft/blog" data-repo-id="MDEwOlJlcG9zaXRvcnk5MTQ0MTQ5Nw==" data-category="Announcements" data-category-id="DIC_kwDOBXNJWc4CT54-" data-mapping="  mapping: pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>></script><div class="copyright"><p>© 2013 - 2025 <a href="https://www.iloft.xyz">Yu</a>, Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="/sitemap.xml" target="_blank">Sitemap</a></p><p><a href="https://beian.miit.gov.cn/" target="_blank">苏ICP备16033901号-3</a></p></div></footer></div><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-89639365-1","auto"),ga("send","pageview")</script></body></html>